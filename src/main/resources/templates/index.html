<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Product Messages</title>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

    <style>
        body {
            background-color: #f8f9fa;
        }

        .container {
            margin-top: 50px;
        }

        .card {
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
        }

        .card:hover {
            transform: scale(1.02);
        }

        #messageList {
            margin-top: 30px;
        }

        .btn-send {
            background-color: #0d6efd;
            color: white;
        }

        .spinner-border {
            width: 1rem;
            height: 1rem;
            border-width: 2px;
        }

        #alertBox {
            display: none;
        }
    </style>
</head>
<body>
<div class="container">
    <h1 class="mb-4 text-center">📦 Product Message Center</h1>

    <!-- 알림 -->
    <div id="alertBox" class="alert" role="alert"></div>

    <!-- 입력 폼 -->
    <div class="card p-4 mb-4">
        <h4>Send New Message</h4>
        <form id="messageForm">
            <div class="mb-3">
                <label class="form-label">Title</label>
                <input type="text" id="title" class="form-control" required>
            </div>

            <div class="mb-3">
                <label class="form-label">Quantity</label>
                <input type="number" id="quantity" class="form-control" required>
            </div>

            <div class="mb-3">
                <label class="form-label">Product Code</label>
                <input type="text" id="productCode" class="form-control" required>
            </div>

            <div class="mb-3">
                <label class="form-label">Content</label>
                <textarea id="content" class="form-control" rows="3" required></textarea>
            </div>

            <button type="submit" class="btn btn-send w-100" id="sendBtn">
                🚀 Send Message
            </button>
        </form>
    </div>

    <!-- 메시지 리스트 -->
    <div>
        <h4>📜 Sent Messages</h4>
        <div id="messageList" class="row"></div>
    </div>
</div>

<script>
    console.log("🚀 JS loaded once"); // 중복 로드 디버그용

    const apiUrl = "/api/messages";

    // ✅ 알림 표시 함수
    function showAlert(message, type = "success") {
        const alertBox = document.getElementById("alertBox");
        alertBox.className = `alert alert-${type}`;
        alertBox.textContent = message;
        alertBox.style.display = "block";
        setTimeout(() => alertBox.style.display = "none", 2500);
    }

    // ✅ 메시지 목록 로드
    async function loadMessages() {
        try {
            const res = await fetch(apiUrl);
            const messages = await res.json();

            const list = document.getElementById("messageList");
            list.innerHTML = "";

            messages.reverse().forEach(msg => {
                const card = document.createElement("div");
                card.className = "col-md-4 mb-3";
                card.innerHTML = `
                    <div class="card p-3">
                        <h5>${msg.title}</h5>
                        <p><strong>Product:</strong> ${msg.productCode}</p>
                        <p><strong>Quantity:</strong> ${msg.quantity}</p>
                        <p>${msg.content}</p>
                    </div>
                `;
                list.appendChild(card);
            });
        } catch (err) {
            console.error("❌ Failed to load messages:", err);
        }
    }

    // ✅ 이벤트 중복 방지 및 등록
    function initFormHandler() {
        const form = document.getElementById("messageForm");
        const btn = document.getElementById("sendBtn");

        // 이전 이벤트 제거 (핵심!)
        form.onsubmit = null;

        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            // 버튼 상태 변경
            btn.disabled = true;
            btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Sending...`;

            const data = {
                title: document.getElementById("title").value,
                quantity: parseInt(document.getElementById("quantity").value),
                productCode: document.getElementById("productCode").value,
                content: document.getElementById("content").value
            };

            try {
                const res = await fetch(apiUrl, {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    showAlert("✅ Message sent successfully!", "success");
                    form.reset();
                    await loadMessages();
                } else {
                    showAlert("❌ Failed to send message", "danger");
                }
            } catch (error) {
                showAlert("⚠️ Network error occurred", "warning");
                console.error(error);
            } finally {
                btn.disabled = false;
                btn.innerHTML = "🚀 Send Message";
            }
        });
    }

    // ✅ 페이지 로드 시 초기화
    window.addEventListener("DOMContentLoaded", async () => {
        await loadMessages();
        initFormHandler();
    });
</script>
</body>
</html>
